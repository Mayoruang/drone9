# 地理围栏管理模块

## 功能概述

地理围栏管理模块为无人机系统提供了完整的地理围栏创建、管理和监控功能。支持设置禁飞区和允飞区，实现对无人机飞行区域的精确控制。

## 主要特性

### 🗺️ 地图功能
- **百度地图集成**: 使用百度地图API (密钥: `PmtVSHO54O3gJgO3Z9J1VnYP07uHE3TE`)
- **地图中心**: 沈阳市 (123.429°, 41.796°)
- **多边形绘制**: 支持点击绘制多边形围栏
- **实时预览**: 绘制过程中显示多边形预览
- **交互控制**: 双击/回车完成绘制，ESC取消绘制

### 🚁 围栏类型
- **禁飞区 (NO_FLY_ZONE)**: 红色标识，禁止无人机进入
- **允飞区 (FLY_ZONE)**: 绿色标识，允许无人机飞行

### 📋 围栏管理
- **围栏列表**: 显示所有已创建的地理围栏
- **详细信息**: 围栏名称、类型、描述、坐标、创建时间
- **缩略图**: 智能生成的SVG地图风格缩略图，显示围栏形状和位置信息，包含地图网格、道路模拟、指北针等元素
- **关联管理**: 支持围栏与无人机的多对多关联

### 🎛️ 操作功能
- **缩略图定位**: 点击地图风格的SVG缩略图快速定位到地图对应位置
- **详情查看**: 点击详情按钮查看完整的围栏信息，包括高清SVG预览、详细坐标、关联无人机等
- **删除确认**: 删除围栏前显示确认对话框，支持批量操作
- **批量选择**: 支持为围栏关联多个无人机

## 使用指南

### 创建地理围栏

1. **开始绘制**
   - 点击页面右上角的"开始绘制围栏"按钮
   - 地图进入绘制模式，光标变为十字形

2. **绘制多边形**
   - 在地图上点击添加围栏顶点
   - 至少需要3个点才能形成有效多边形
   - 绘制过程中显示实时多边形预览

3. **完成绘制**
   - 双击鼠标完成绘制
   - 或按下 `Enter` 键完成
   - 按 `ESC` 键取消绘制（清除所有已绘制的点）

4. **设置属性**
   - 绘制完成后弹出设置对话框
   - 输入围栏名称（必填）
   - 选择围栏类型（禁飞区/允飞区）
   - 添加描述信息（可选）
   - 选择关联的无人机（可选）
   - **表单取消**: 如果在设置表单中点击取消，将撤销整个绘制操作，清除所有已绘制的点

### 管理地理围栏

1. **快速定位**
   - 点击围栏缩略图快速定位到地图位置
   - 地图自动调整视野以显示完整围栏

2. **查看详情**
   - 点击"详情"按钮打开右侧抽屉面板（与无人机监控页面风格一致）
   - 查看完整的围栏信息：
     - 基本信息：名称、类型、描述、创建时间、ID
     - 地理信息：中心坐标、顶点数量、关联无人机数量
     - 围栏形状：大尺寸预览图
     - 详细坐标：所有顶点的精确经纬度
     - 关联无人机：已关联的无人机列表
   - 抽屉标题栏提供快捷操作按钮（地图定位、删除）

3. **删除围栏**
   - 点击"删除"按钮
   - 确认删除对话框显示围栏详细信息
   - 删除后自动从地图移除

### 交互优化

- **避免功能重复**: 移除了冗余的定位按钮，缩略图点击即可定位
- **详情功能增强**: 详情按钮现在显示右侧抽屉面板，提供完整的围栏信息展示
- **操作流程简化**: 两个主要按钮（详情、删除）+ 缩略图定位，操作更清晰
- **视觉一致性**: 抽屉样式与无人机状态监控页面保持一致，提供统一的用户体验
- **绘制取消优化**: ESC键现在可以完全清除所有已绘制的点和覆盖物，提供更好的绘制控制
- **表单取消优化**: 在设置表单中点击取消会撤销整个绘制操作，确保不会留下未完成的围栏

### 取消操作说明

1. **绘制过程中取消**:
   - 按 `ESC` 键或点击"取消绘制"按钮
   - 清除所有已绘制的点和预览图形
   - 退出绘制模式

2. **表单设置中取消**:
   - 在完成绘制后的设置表单中点击"取消"
   - 撤销整个绘制操作，包括所有坐标数据
   - 确保不会创建未完成的围栏
   - 返回到非绘制状态

> **注意**: 无论在绘制过程中还是在表单设置阶段，所有的取消操作都会完全清理相关状态，确保没有遗留的临时数据或未完成的围栏对象。已修复表单取消后预览多边形残留的问题。

## 技术实现

### 组件结构
```geofence/
├── index.vue              # 主页面组件
├── components/
│   ├── GeofenceMap.vue     # 地图组件
│   └── GeofenceList.vue    # 列表组件
└── README.md              # 说明文档
```

### 关键技术

1. **Vue 3 Composition API**: 使用最新的Vue 3语法
2. **TypeScript**: 完整的类型定义和检查
3. **Ant Design Vue**: 现代化UI组件库
4. **百度地图API**: 地图服务和绘制功能
5. **SVG矢量图形**: 智能生成地图风格的围栏缩略图，支持动态缩放和自定义样式
6. **绘制状态管理**: 精确跟踪和清理绘制过程中的所有覆盖物

### 缩略图技术细节

- **SVG矢量缩略图**: 使用SVG技术生成地图风格的围栏缩略图，确保在任何分辨率下都清晰显示
- **智能布局**: 根据围栏坐标边界自动计算最佳显示区域和缩放比例
- **地图元素模拟**: 包含网格线、道路、指北针等地图元素，提供真实的地图观感
- **动态样式**: 根据围栏类型（禁飞区/允飞区）自动应用相应的颜色主题
- **多尺寸支持**: 列表中使用100x100像素，详情页使用200x200像素高清图
- **性能优化**: 纯客户端生成，无网络请求，加载速度快

### 百度地图静态图API状态

目前百度地图静态图API遇到技术问题（HTTP 500错误），可能原因：
- API密钥权限问题
- 请求参数格式不兼容
- 服务暂时不可用

**解决方案**：已实现SVG备用方案，提供更好的用户体验：
- ✅ 零网络延迟
- ✅ 完全可控的样式
- ✅ 响应式设计
- ✅ 无API配额限制

**未来计划**：
- [ ] 研究百度地图静态图API的正确调用方式
- [ ] 考虑集成其他地图服务商的静态图API
- [ ] 继续优化SVG缩略图的视觉效果

### 数据结构

```typescript
interface GeofenceData {
  id: string;                                    // 唯一标识
  name: string;                                  // 围栏名称
  type: 'NO_FLY_ZONE' | 'FLY_ZONE';            // 围栏类型
  coordinates: Array<{ lng: number; lat: number }>; // 坐标点
  description?: string;                          // 描述信息
  createTime: string;                           // 创建时间
  droneIds?: string[];                          // 关联无人机ID
}
```

## 路由配置

地理围栏管理页面已集成到主导航中：

- **路径**: `/geofence`
- **名称**: `Geofence`
- **图标**: `mdi:map-marker-radius`
- **标题**: "地理围栏管理"

## Mock数据

系统包含示例数据，包括：
- 沈阳浑南禁飞区
- 机场周边允飞区
- 5架示例无人机（大疆、Autel、Yuneec等品牌）

## 未来扩展

- [ ] 支持导入/导出KML文件
- [ ] 围栏生效时间设置
- [ ] 围栏优先级管理
- [ ] 实时违规告警
- [ ] 围栏使用统计
- [ ] 与后端API集成
