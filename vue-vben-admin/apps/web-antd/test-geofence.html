<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°ç†å›´æ APIæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .response { background: #f8f9fa; padding: 10px; border-radius: 3px; margin-top: 10px; white-space: pre-wrap; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>åœ°ç†å›´æ APIæµ‹è¯•</h1>

        <div class="section">
            <h3>1. æµ‹è¯•APIè¿æ¥</h3>
            <button onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
            <div id="connectionResult"></div>
        </div>

        <div class="section">
            <h3>2. åˆ›å»ºåœ°ç†å›´æ </h3>
            <input type="text" id="geofenceName" placeholder="å›´æ åç§°" value="å‰ç«¯æµ‹è¯•å›´æ ">
            <textarea id="geofenceDescription" placeholder="å›´æ æè¿°" rows="2">é€šè¿‡å‰ç«¯é¡µé¢åˆ›å»ºçš„æµ‹è¯•å›´æ </textarea>
            <select id="geofenceType">
                <option value="NO_FLY_ZONE">ç¦é£åŒº</option>
                <option value="RESTRICTED_ZONE">é™åˆ¶åŒº</option>
                <option value="FLY_ZONE">å…é£åŒº</option>
            </select>
            <input type="number" id="altitudeMin" placeholder="æœ€ä½é«˜åº¦(ç±³)" value="0">
            <input type="number" id="altitudeMax" placeholder="æœ€é«˜é«˜åº¦(ç±³)" value="120">
            <button onclick="createGeofence()">åˆ›å»ºå›´æ </button>
            <div id="createResult"></div>
        </div>

        <div class="section">
            <h3>3. è·å–åœ°ç†å›´æ åˆ—è¡¨</h3>
            <button onclick="loadGeofences()">åŠ è½½åˆ—è¡¨</button>
            <div id="listResult"></div>
        </div>

        <div class="section">
            <h3>4. åˆ é™¤åœ°ç†å›´æ </h3>
            <input type="text" id="deleteGeofenceId" placeholder="è¾“å…¥å›´æ ID">
            <button onclick="deleteGeofence()">åˆ é™¤å›´æ </button>
            <div id="deleteResult"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api/v1';

        async function testConnection() {
            const resultDiv = document.getElementById('connectionResult');
            try {
                const response = await fetch(`${API_BASE}/geofences/test`);
                const text = await response.text();

                if (text.includes('working')) {
                    resultDiv.innerHTML = `<div class="success">âœ… è¿æ¥æˆåŠŸ: ${text}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">âŒ è¿æ¥å¼‚å¸¸: ${text}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ è¿æ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function createGeofence() {
            const resultDiv = document.getElementById('createResult');
            const name = document.getElementById('geofenceName').value;
            const description = document.getElementById('geofenceDescription').value;
            const type = document.getElementById('geofenceType').value;
            const altitudeMin = parseInt(document.getElementById('altitudeMin').value) || 0;
            const altitudeMax = parseInt(document.getElementById('altitudeMax').value) || 120;

            if (!name.trim()) {
                resultDiv.innerHTML = '<div class="error">âŒ è¯·è¾“å…¥å›´æ åç§°</div>';
                return;
            }

            const geofenceData = {
                name: name,
                description: description,
                geometry: {
                    type: "Polygon",
                    coordinates: [[[116.404, 39.915], [116.405, 39.915], [116.405, 39.916], [116.404, 39.916], [116.404, 39.915]]]
                },
                geofenceType: type,
                active: true,
                altitudeMin: altitudeMin,
                altitudeMax: altitudeMax,
                droneIds: []
            };

            try {
                resultDiv.innerHTML = '<div>ğŸ”„ æ­£åœ¨åˆ›å»º...</div>';

                const response = await fetch(`${API_BASE}/geofences`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(geofenceData)
                });

                const result = await response.json();

                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="success">âœ… åˆ›å»ºæˆåŠŸ!</div>
                        <div class="response">å“åº”: ${JSON.stringify(result, null, 2)}</div>
                    `;

                    // è‡ªåŠ¨åˆ·æ–°åˆ—è¡¨
                    setTimeout(() => {
                        loadGeofences();
                    }, 2000);
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">âŒ åˆ›å»ºå¤±è´¥: ${result.message}</div>
                        <div class="response">å“åº”: ${JSON.stringify(result, null, 2)}</div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>
                `;
            }
        }

        async function loadGeofences() {
            const resultDiv = document.getElementById('listResult');

            try {
                resultDiv.innerHTML = '<div>ğŸ”„ æ­£åœ¨åŠ è½½...</div>';

                const response = await fetch(`${API_BASE}/geofences?page=0&size=20`);
                const result = await response.json();

                if (result.content && Array.isArray(result.content)) {
                    let html = `<div class="success">âœ… åŠ è½½æˆåŠŸ! å…± ${result.totalElements} ä¸ªå›´æ </div>`;

                    result.content.forEach((item, index) => {
                        html += `
                            <div class="response" style="margin-top: 10px; position: relative;">
                                <strong>${index + 1}. ${item.name}</strong>
                                <button onclick="deleteGeofenceById('${item.geofenceId}')" style="position: absolute; top: 5px; right: 5px; background: #dc3545; font-size: 12px; padding: 5px 8px;">åˆ é™¤</button><br>
                                ID: ${item.geofenceId}<br>
                                ç±»å‹: ${item.geofenceType}<br>
                                çŠ¶æ€: ${item.active ? 'å¯ç”¨' : 'ç¦ç”¨'}<br>
                                ${item.altitudeMin !== undefined ? `é«˜åº¦é™åˆ¶: ${item.altitudeMin}-${item.altitudeMax}ç±³<br>` : ''}
                                åˆ›å»ºæ—¶é—´: ${new Date(item.createdAt).toLocaleString()}<br>
                                ${item.thumbnailUrl ? `ç¼©ç•¥å›¾: <a href="${item.thumbnailUrl}" target="_blank">æŸ¥çœ‹</a><br>` : ''}
                                æè¿°: ${item.description || 'æ— '}
                            </div>
                        `;
                    });

                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div class="error">âŒ æ•°æ®æ ¼å¼å¼‚å¸¸</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function deleteGeofence() {
            const resultDiv = document.getElementById('deleteResult');
            const geofenceId = document.getElementById('deleteGeofenceId').value.trim();

            if (!geofenceId) {
                resultDiv.innerHTML = '<div class="error">âŒ è¯·è¾“å…¥å›´æ ID</div>';
                return;
            }

            try {
                resultDiv.innerHTML = '<div>ğŸ”„ æ­£åœ¨åˆ é™¤...</div>';

                const response = await fetch(`${API_BASE}/geofences/${geofenceId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="success">âœ… åˆ é™¤æˆåŠŸ!</div>
                        <div class="response">å“åº”: ${JSON.stringify(result, null, 2)}</div>
                    `;

                    // æ¸…ç©ºè¾“å…¥æ¡†
                    document.getElementById('deleteGeofenceId').value = '';

                    // è‡ªåŠ¨åˆ·æ–°åˆ—è¡¨
                    setTimeout(() => {
                        loadGeofences();
                    }, 1000);
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">âŒ åˆ é™¤å¤±è´¥: ${result.message}</div>
                        <div class="response">å“åº”: ${JSON.stringify(result, null, 2)}</div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>
                `;
            }
        }

        async function deleteGeofenceById(geofenceId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåœ°ç†å›´æ å—ï¼Ÿ')) {
                return;
            }

            const resultDiv = document.getElementById('listResult');

            try {
                const response = await fetch(`${API_BASE}/geofences/${geofenceId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    // è‡ªåŠ¨åˆ·æ–°åˆ—è¡¨
                    loadGeofences();
                } else {
                    alert(`åˆ é™¤å¤±è´¥: ${result.message}`);
                }
            } catch (error) {
                alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•è¿æ¥
        window.onload = function() {
            testConnection();
        };
    </script>
</body>
</html>
