# MQTTåŠŸèƒ½æµ‹è¯•æŒ‡å—

## åŠŸèƒ½æ¦‚è¿°
å·²å®Œæˆä»å‰ç«¯åˆ°åç«¯çš„MQTTæ¶ˆæ¯å‘é€åŠŸèƒ½å®ç°ï¼Œæ”¯æŒï¼š

### 1. æ§åˆ¶å°æ¶ˆæ¯ (Console Messages)
- **ç”¨é€”**: å‘é€ç®€å•çš„æ§åˆ¶å°æ¶ˆæ¯ç»™æ— äººæœº
- **ç‰¹æ€§**: 
  - ä¼˜å…ˆçº§è®¾ç½® (LOW/NORMAL/HIGH)
  - å¯é€‰æ‹©æ˜¯å¦éœ€è¦ç¡®è®¤ (requireAck)
  - æ¶ˆæ¯é•¿åº¦é™åˆ¶: 1000å­—ç¬¦
  - **ä¸“ç”¨ä¸»é¢˜**: `drones/{droneId}/console`ï¼ˆåŒºåˆ«äºé€šç”¨æŒ‡ä»¤ä¸»é¢˜ï¼‰

### 2. è‡ªå®šä¹‰MQTTæ¶ˆæ¯ (Custom MQTT Messages)
- **ç”¨é€”**: å‘é€åˆ°è‡ªå®šä¹‰MQTTä¸»é¢˜çš„æ¶ˆæ¯
- **ç‰¹æ€§**:
  - è‡ªå®šä¹‰ä¸»é¢˜è·¯å¾„
  - QoSçº§åˆ«é€‰æ‹© (0/1/2)
  - ä¿ç•™æ¶ˆæ¯é€‰é¡¹
  - æ¶ˆæ¯ç±»å‹é€‰æ‹© (COMMAND/NOTIFICATION/CUSTOM)
  - æ¶ˆæ¯é•¿åº¦é™åˆ¶: 2000å­—ç¬¦

## âœ… å·²è§£å†³çš„é—®é¢˜

### 1. APIè·¯å¾„é‡å¤é—®é¢˜
- **é—®é¢˜**: å‰ç«¯APIè°ƒç”¨ä¸­å‡ºç°é‡å¤çš„`/api`è·¯å¾„ï¼Œå¯¼è‡´è¯·æ±‚URLå˜æˆ`/api/api/v1/...`
- **è§£å†³æ–¹æ¡ˆ**: ä¿®å¤äº†å‰ç«¯APIè·¯å¾„é…ç½®
- **çŠ¶æ€**: âœ… å·²è§£å†³

### 2. æ§åˆ¶å°æ¶ˆæ¯ä¸»é¢˜é—®é¢˜
- **é—®é¢˜**: æ§åˆ¶å°æ¶ˆæ¯ä½¿ç”¨é€šç”¨çš„`/commands`ä¸»é¢˜ï¼Œä¸å¤Ÿæ¸…æ™°
- **è§£å†³æ–¹æ¡ˆ**: ä¸ºæ§åˆ¶å°æ¶ˆæ¯åˆ›å»ºä¸“ç”¨ä¸»é¢˜`/console`
- **ä¿®æ”¹å‰**: `drones/{droneId}/commands`ï¼ˆä¸é€šç”¨æŒ‡ä»¤æ··åœ¨ä¸€èµ·ï¼‰
- **ä¿®æ”¹å**: `drones/{droneId}/console`ï¼ˆä¸“ç”¨æ§åˆ¶å°ä¸»é¢˜ï¼‰
- **çŠ¶æ€**: âœ… å·²è§£å†³

### 3. å‰ç«¯é”™è¯¯å¤„ç†é—®é¢˜
- **é—®é¢˜**: æˆåŠŸçš„APIå“åº”è¢«å‰ç«¯å½“ä½œé”™è¯¯å¤„ç†ï¼Œæ˜¾ç¤º"å‘é€MQTTæ¶ˆæ¯å¤±è´¥"
- **åŸå› **: åç«¯è¿”å›äº†é”™è¯¯çš„HTTPçŠ¶æ€ç ï¼ˆ400ï¼‰ï¼Œä½†å“åº”ä½“ä¸­successå­—æ®µä¸ºtrue
- **è§£å†³æ–¹æ¡ˆ**: ä¿®æ”¹æ§åˆ¶å™¨è¿”å›é€»è¾‘ï¼Œç¡®ä¿HTTPçŠ¶æ€ç ä¸å“åº”å†…å®¹ä¸€è‡´
  - æˆåŠŸæ—¶è¿”å›200çŠ¶æ€ç 
  - å¤±è´¥æ—¶è¿”å›500çŠ¶æ€ç 
- **çŠ¶æ€**: âœ… å·²è§£å†³

### 4. æƒé™è®¤è¯é—®é¢˜ â­ **æœ€ç»ˆè§£å†³**
- **é—®é¢˜**: MQTT APIç«¯ç‚¹è¿”å›"Access Denied"é”™è¯¯
- **æ ¹æœ¬åŸå› **: JWTè¿‡æ»¤å™¨é…ç½®é—®é¢˜å’ŒSpring Securityé…ç½®å†²çª
- **è¯¦ç»†åˆ†æ**:
  1. **JWTè¿‡æ»¤å™¨æ’é™¤è·¯å¾„è¿‡äºå®½æ³›**: `/api/v1/drones/**`è¢«å®Œå…¨æ’é™¤ï¼Œå¯¼è‡´MQTTç«¯ç‚¹ä¸è¿›è¡ŒJWTéªŒè¯
  2. **å®‰å…¨é…ç½®å†²çª**: åŒæ—¶ä½¿ç”¨äº†`permitAll()`å’Œ`@PreAuthorize`æ³¨è§£ï¼Œå¯¼è‡´æƒé™æ£€æŸ¥å¤±æ•ˆ
  3. **è§’è‰²åç§°ä¸åŒ¹é…**: æ•°æ®åº“ä¸­è§’è‰²ä¸º`admin`ï¼Œä½†Spring Securityéœ€è¦`ROLE_ADMIN`æ ¼å¼

- **è§£å†³æ–¹æ¡ˆ**:
  1. **ä¿®æ”¹JWTè¿‡æ»¤å™¨**: ç§»é™¤å¯¹æ‰€æœ‰æ— äººæœºAPIçš„æ’é™¤ï¼Œåªä¿ç•™ç‰¹å®šä¸éœ€è¦è®¤è¯çš„ç«¯ç‚¹
  2. **ä¿®æ­£å®‰å…¨é…ç½®**: è®©MQTTç«¯ç‚¹æ­£ç¡®è¿›è¡Œè®¤è¯å’Œæˆæƒ
  3. **ä½¿ç”¨æ­£ç¡®çš„è§’è‰²åç§°**: `@PreAuthorize("hasRole('ADMIN') or hasRole('SUPER')")`
  4. **ç¡®ä¿JWTä»¤ç‰Œæ­£ç¡®è§£æ**: ä¿®å¤ä»¤ç‰ŒéªŒè¯é€»è¾‘

- **æœ€ç»ˆé…ç½®**:
  ```java
  // JWTè¿‡æ»¤å™¨æ’é™¤è·¯å¾„ï¼ˆç§»é™¤äº†/api/v1/drones/**ï¼‰
  "/api/auth/**", "/api/test/**", "/api/status", 
  "/api/v1/drones/register", "/api/v1/drones/registration/**", 
  "/api/v1/drones/management/**", "/api/v1/drones/test/**", 
  "/api/v1/geofences/**", "/actuator/**"
  
  // å®‰å…¨é…ç½®
  .requestMatchers("/api/v1/drones/*/console-message").authenticated()
  .requestMatchers("/api/v1/drones/*/mqtt-message").authenticated()
  .requestMatchers("/api/v1/drones/**").permitAll()
  
  // æ§åˆ¶å™¨æƒé™æ£€æŸ¥
  @PreAuthorize("hasRole('ADMIN') or hasRole('SUPER')")
  ```

- **çŠ¶æ€**: âœ… **å®Œå…¨è§£å†³**

### 5. WebSocketè¿æ¥é—®é¢˜ â­ **æ–°è§£å†³**
- **é—®é¢˜**: å‰ç«¯WebSocketè¿æ¥å¤±è´¥ï¼Œé”™è¯¯ä»£ç 1002ï¼ŒåŸå› "Cannot connect to server"
- **ç—‡çŠ¶**: 
  - 403 Forbiddené”™è¯¯è®¿é—®WebSocketèµ„æº
  - WebSocketè¿æ¥å¤±è´¥ï¼Œæ— æ³•æ¥æ”¶å®æ—¶æ•°æ®
- **æ ¹æœ¬åŸå› **: Spring Securityé…ç½®ä¸­æ²¡æœ‰å…è®¸WebSocketç«¯ç‚¹è®¿é—®
- **è§£å†³æ–¹æ¡ˆ**: åœ¨å®‰å…¨é…ç½®ä¸­æ·»åŠ WebSocketç«¯ç‚¹çš„è®¿é—®æƒé™
  ```java
  .requestMatchers("/ws/**").permitAll()
  .requestMatchers("/websocket-test").permitAll()
  .requestMatchers("/mqtt-test").permitAll()
  ```
- **éªŒè¯ç»“æœ**: 
  - âœ… WebSocketç«¯ç‚¹ç°åœ¨è¿”å›"Welcome to SockJS!"
  - âœ… å‰ç«¯å¯ä»¥æ­£å¸¸å»ºç«‹WebSocketè¿æ¥
  - âœ… å®æ—¶æ•°æ®æ¨é€åŠŸèƒ½æ¢å¤æ­£å¸¸
- **çŠ¶æ€**: âœ… **å®Œå…¨è§£å†³**

## ğŸ§ª APIæµ‹è¯•ç»“æœ

### æ§åˆ¶å°æ¶ˆæ¯APIæµ‹è¯•
```bash
curl -X POST http://localhost:8080/api/v1/drones/{droneId}/console-message \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {JWT_TOKEN}" \
  -d '{"message":"test console message","priority":"NORMAL","requireAck":false}'
```

**æˆåŠŸå“åº”**:
```json
{
  "success": true,
  "message": "Console message sent successfully",
  "droneId": "9ff622db-4b8f-4724-99c6-ae70be9c313c",
  "topic": "drones/9ff622db-4b8f-4724-99c6-ae70be9c313c/console",
  "timestamp": "2025-05-27T20:03:01.854339+08:00",
  "messageId": "196f28ba-8be6-4a7e-8d1c-dacccd7da2a9",
  "errorDetails": null
}
```

### è‡ªå®šä¹‰MQTTæ¶ˆæ¯APIæµ‹è¯•
```bash
curl -X POST http://localhost:8080/api/v1/drones/{droneId}/mqtt-message \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {JWT_TOKEN}" \
  -d '{"topic":"drones/test/custom","message":"test custom mqtt message","qos":1,"retained":false,"messageType":"CUSTOM"}'
```

**æˆåŠŸå“åº”**:
```json
{
  "success": true,
  "message": "MQTT message sent successfully",
  "droneId": "9ff622db-4b8f-4724-99c6-ae70be9c313c",
  "topic": "drones/test/custom",
  "timestamp": "2025-05-27T20:01:37.537617+08:00",
  "messageId": "346549ee-71a6-4a4b-9ab6-b74ea2ec7af0",
  "errorDetails": null
}
```

## ğŸ“‹ ä½¿ç”¨è¯´æ˜

### å‰ç«¯ä½¿ç”¨æ­¥éª¤
1. **ç™»å½•ç³»ç»Ÿ**: ä½¿ç”¨å…·æœ‰ADMINæˆ–SUPERè§’è‰²çš„ç”¨æˆ·è´¦å·ç™»å½•
   - é»˜è®¤ç®¡ç†å‘˜è´¦å·: `admin` / `123456`
   - é»˜è®¤è¶…çº§ç”¨æˆ·: `vben` / `123456`

2. **é€‰æ‹©æ— äººæœº**: åœ¨æ— äººæœºç®¡ç†ç•Œé¢é€‰æ‹©ç›®æ ‡æ— äººæœº

3. **å‘é€æ¶ˆæ¯**: 
   - **æ§åˆ¶å°æ¶ˆæ¯**: ç”¨äºç®€å•çš„æŒ‡ä»¤å‘é€ï¼Œä½¿ç”¨ä¸“ç”¨æ§åˆ¶å°ä¸»é¢˜
   - **è‡ªå®šä¹‰MQTTæ¶ˆæ¯**: ç”¨äºé«˜çº§ç”¨æˆ·ï¼Œå¯è‡ªå®šä¹‰ä¸»é¢˜å’Œå‚æ•°

### æƒé™è¦æ±‚
- **å¿…éœ€è§’è‰²**: ADMIN æˆ– SUPER
- **è®¤è¯æ–¹å¼**: JWT Bearer Token
- **ä»¤ç‰Œè·å–**: é€šè¿‡`/api/auth/login`ç«¯ç‚¹ç™»å½•è·å–

### æ•…éšœæ’é™¤
1. **403 Forbiddené”™è¯¯**: æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ä¸”å…·æœ‰æ­£ç¡®æƒé™
2. **401 Unauthorizedé”™è¯¯**: æ£€æŸ¥JWTä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆ
3. **500 Internal Server Error**: æ£€æŸ¥åç«¯æ—¥å¿—ï¼Œå¯èƒ½æ˜¯MQTTæœåŠ¡è¿æ¥é—®é¢˜

## ğŸ“Š åŠŸèƒ½çŠ¶æ€æ€»ç»“

| åŠŸèƒ½æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| æ§åˆ¶å°æ¶ˆæ¯å‘é€ | âœ… å®Œæˆ | ä½¿ç”¨ä¸“ç”¨ä¸»é¢˜`/console` |
| è‡ªå®šä¹‰MQTTæ¶ˆæ¯ | âœ… å®Œæˆ | æ”¯æŒè‡ªå®šä¹‰ä¸»é¢˜å’Œå‚æ•° |
| å‰ç«¯APIé›†æˆ | âœ… å®Œæˆ | æ­£ç¡®çš„é”™è¯¯å¤„ç†å’ŒçŠ¶æ€ç  |
| æƒé™è®¤è¯ | âœ… å®Œæˆ | JWTè®¤è¯ + è§’è‰²æˆæƒ |
| é”™è¯¯å¤„ç† | âœ… å®Œæˆ | ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼ |
| WebSocketè¿æ¥ | âœ… å®Œæˆ | å®æ—¶æ•°æ®æ¨é€å’Œé€šä¿¡ |

**ğŸ‰ æ‰€æœ‰MQTTæ¶ˆæ¯å‘é€åŠŸèƒ½å’ŒWebSocketå®æ—¶é€šä¿¡å·²å®Œå…¨å®ç°å¹¶æµ‹è¯•é€šè¿‡ï¼** 